<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>OpenPGP</title>
    </head>
    <body>
        <script>
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.console) {
                // Spread syntax (...args) to capture all arguments
                console.log = function (...args) {
                    // Join the args with a space (or whatever delimiter you prefer)
                    const joined = args.map(a =>
                        typeof a === 'object' ? JSON.stringify(a) : String(a)
                    ).join(' ');
                    window.webkit.messageHandlers.console.postMessage(joined);
                };
                
                console.error = function (...args) {
                    const joined = args.map(a =>
                        typeof a === 'object' ? JSON.stringify(a) : String(a)
                    ).join(' ');
                    window.webkit.messageHandlers.console.postMessage("Error: " + joined);
                };
            }

            window.keys = { result: null };

            const script = document.createElement('script');
            script.src = "openpgp.min.js";
            
            script.onload = async () => {
                console.log("OpenPGP.js loaded successfully");
                
                // ---------------------------------------------
                // Example debugging code for 'encryptMessage':
                // ---------------------------------------------
                window.encryptMessage = async function encryptMessage(message, publicKeyArmored) {
                    try {
                        console.log("[encryptMessage] Starting with message length:", message.length);
                        const publicKey = await openpgp.readKey({ armoredKey: publicKeyArmored });
                        console.log("[encryptMessage] Public key loaded");
                        
                        const pgpMessage = await openpgp.createMessage({ text: message });
                        console.log("[encryptMessage] Message created");
                        
                        const encrypted = await openpgp.encrypt({
                            message: pgpMessage,
                            encryptionKeys: [publicKey],
                            format: 'armored'
                        });
                        
                        console.log("[encryptMessage] Encryption complete");
                        window.encryptedResult = encrypted;
                        return encrypted;
                    } catch (error) {
                        console.error("[encryptMessage] Error:", error);
                        window.encryptedResult = 'error:' + error.message;
                        throw error;
                    }
                }

                // ---------------------------------------------
                // If you also want to debug the underlying
                // openpgp.encrypt call directly, you can add
                // logs around it or wrap it in a helper:
                // ---------------------------------------------
                window.debugEncrypt = async function (message, publicKey) {
                    console.log("debugEncrypt called");
                    try {
                        console.log("Creating OpenPGP message object (debugEncrypt)...");
                        const msgObj = await openpgp.createMessage({ text: message });
                        console.log("Message object created, starting openpgp.encrypt...");

                        const encrypted = await openpgp.encrypt({
                            message: msgObj,
                            encryptionKeys: [publicKey],
                            format: 'armored'
                        });

                        console.log("debugEncrypt finished, length:", encrypted.length);
                        return encrypted;
                    } catch (error) {
                        console.error("debugEncrypt error:", error);
                        throw error; // re-throw for upper-level handling
                    }
                };

                // ---------------------------------------------
                // A few other helpers as in your original code:
                // ---------------------------------------------
                window.getEncryptedMessage = function() {
                    const result = window.lastEncryptedMessage || '';
                    window.lastEncryptedMessage = null;
                    return result;
                };

                window.generatePGPKeySync = function(name, email, passphrase) {
                    console.log("Starting sync key generation");
                    
                    openpgp.generateKey({
                        type: 'ecc',
                        curve: 'ed25519',
                        userIDs: [{ name, email }],
                        passphrase,
                        format: 'armored'
                    }).then(function(key) {
                        console.log("Key generated, storing result");
                        window.keys.result = JSON.stringify({
                            privateKey: key.privateKey,
                            publicKey: key.publicKey
                        });
                    }).catch(function(error) {
                        console.error("Generation error:", error);
                        window.keys.result = JSON.stringify({ error: error.toString() });
                    });

                    return "Generation started";
                };

                window.getGeneratedKeys = function() {
                    console.log("Getting generated keys");
                    if (window.keys.result) {
                        const result = window.keys.result;
                        window.keys.result = null;
                        return result;
                    }
                    return "";
                };

                window.decryptMessage = async function(encryptedText, privateKeyArmored, passphrase = '') {
                    try {
                        console.log('[decryptMessage] Starting decryption');
                        console.log('[decryptMessage] Encrypted text length:', encryptedText.length);
                        console.log('[decryptMessage] Private key length:', privateKeyArmored.length);
                        
                        console.log('[decryptMessage] Reading private key...');
                        const privateKey = await openpgp.readPrivateKey({ armoredKey: privateKeyArmored });
                        console.log('[decryptMessage] Private key loaded');
                        
                        console.log('[decryptMessage] Processing private key...');
                        const decryptedPrivateKey = passphrase
                            ? await openpgp.decryptKey({ privateKey, passphrase })
                            : privateKey;
                        console.log('[decryptMessage] Private key processed');
                        
                        console.log('[decryptMessage] Reading message...');
                        const message = await openpgp.readMessage({ armoredMessage: encryptedText });
                        console.log('[decryptMessage] Message loaded');
                        
                        console.log('[decryptMessage] Decrypting...');
                        const { data: decrypted } = await openpgp.decrypt({
                            message,
                            decryptionKeys: decryptedPrivateKey
                        });
                        console.log('[decryptMessage] Decryption successful');
                        
                        const result = JSON.stringify({ success: true, decrypted });
                        console.log('[decryptMessage] Result length:', result.length);
                        return result;
                    } catch (error) {
                        console.error('[decryptMessage] Error:', error);
                        return JSON.stringify({
                            success: false,
                            error: error.toString(),
                            needsPassphrase: error.toString().includes('passphrase')
                        });
                    }
                };

                window.isKeyEncrypted = async function(privateKeyArmored) {
                    try {
                        const privateKey = await openpgp.readPrivateKey({ armoredKey: privateKeyArmored });
                        return JSON.stringify({
                            success: true,
                            isEncrypted: privateKey.isEncrypted
                        });
                    } catch (error) {
                        return JSON.stringify({ success: false, error: error.toString() });
                    }
                };
            };

            script.onerror = () => {
                console.error("Failed to load openpgp.min.js");
            };

            document.head.appendChild(script);
        </script>
    </body>
</html>
